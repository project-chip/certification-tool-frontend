<!--
 *
 * Copyright (c) 2023 Project CHIP Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->
<p-dialog [header]="header" (click)="cancel($event)" [visible]="popupId === sharedAPI.getShowCustomPopup()"
  class="custom-popup-parent" [draggable]="true" [ngClass]='{"upload-width": popupId === "upload-popup"}'>
  <div class="subheader">{{subHeader}}</div>

  <div *ngIf="popupId.includes('TWO_WAY_TALK_')">
    <!-- WebRTC Audio Level Bars -->
    <div *ngFor="let session of (sessions$ | async)" class="audio-session-container">
      <video autoplay playsinline [streamSrc]=session.remoteStream$ width="640" height="480"></video>
      <div class="audio-container">
        <ng-container *ngIf="{ remote: session.remoteAudioLevel$ | async, local: session.localAudioLevel$ | async } as levels">
          <div class="audio-level-item">
            <div class="audio-label">Speaker</div>
            <i class="pi pi-volume-up"></i>
            <div class="audio-level-bar-container">
              <div class="audio-level-bar-background"></div>
              <div 
                class="audio-level-bar" 
                [style.width]="getAudioLevelWidth(levels.remote || 0)"
                [style.backgroundColor]="getAudioLevelColor(levels.remote || 0)"
              ></div>
            </div>
            <div class="audio-level-value">{{ levels.remote || 0 | number:'1.0-0' }}%</div>
          </div>
          
          <div class="audio-level-item">
            <div class="audio-label">Mic</div>
            <i class="pi pi-microphone"></i>
            <div class="audio-level-bar-container">
              <div class="audio-level-bar-background"></div>
              <div 
                class="audio-level-bar" 
                [style.width]="getAudioLevelWidth(levels.local || 0)"
                [style.backgroundColor]="getAudioLevelColor(levels.local || 0)"
              ></div>
            </div>
            <div class="audio-level-value">{{ levels.local || 0 | number:'1.0-0' }}%</div>
          </div>
        </ng-container>
      </div>
      <div class="state">
        Peer Connection State: {{ session.connectionState$ | async }}
      </div>
    </div>
  </div>

  <div *ngIf="popupId.includes('STREAM_')">
    <canvas #videoCanvas width="640" height="480"></canvas>
  </div>

  <div *ngIf="popupId.includes('PUSH_')">
    <button pButton type="button" [label]="'Refresh Streams'" [icon]="'pi pi-refresh'"
      (click)="refreshStreams()" [disabled]="isLoading"></button>
    
    <!-- Error Message Display -->
    <div *ngIf="errorMessage" class="error-message">
      <i class="pi pi-exclamation-triangle"></i>
      <span>{{errorMessage}}</span>
    </div>
    
    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-indicator">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Loading streams...</span>
    </div>
    
    <!-- Streams List -->
    <div *ngIf="!isLoading && !errorMessage">
      <div class="streams-list-container">
        <div class="streams-list-header">Available Streams</div>
        <ul class="streams-list">
          <li *ngFor="let stream of testRunAPI.getPushAVStreamsList()" class="stream-item">
            <a href="#" 
               (click)="updateStreamSrc(stream.id); $event.preventDefault()" 
               [class.active]="currentStream === stream.id"
               [attr.aria-label]="'Select Stream ' + stream.id">
              <i class="pi pi-play-circle"></i>
              Stream {{stream.id}}
            </a>
          </li>
        </ul>
        
        <!-- No Streams Message -->
        <div *ngIf="testRunAPI.getPushAVStreamsList().length === 0" class="no-streams-message">
          <i class="pi pi-info-circle"></i>
          <span>No streams available. Click "Refresh Streams" to check for new streams.</span>
        </div>
      </div>
    </div>
    
    <div class="video-player-container">
      <div class="video-player-header">
        <i class="pi pi-play-circle"></i>
        <span>Video Player</span>
      </div>
      <div class="video-player-wrapper">
        <video #videoPlayer width="640" height="480" controls class="video-player">
        </video>
        <div *ngIf="!currentStream" class="video-placeholder">
          <i class="pi pi-video"></i>
          <span>Select a stream to play video</span>
        </div>
      </div>
    </div>
    <div *ngIf="currentStream" class="stream-contents-container">
      <div class="stream-contents-header">
        <i class="pi pi-file"></i>
        <span>Stream {{currentStream}} Contents</span>
      </div>
      <div class="stream-contents-list">
        <div *ngFor="let file of streamContents; let i = index" class="stream-content-item">
          <div class="file-info">
            <i class="pi pi-file-o"></i>
            <span class="file-name">{{file}}</span>
            <span class="file-index">#{{i + 1}}</span>
          </div>
        </div>
        <div *ngIf="!streamContents || streamContents.length === 0" class="no-contents-message">
          <i class="pi pi-info-circle"></i>
          <span>No contents available for this stream</span>
        </div>
      </div>
    </div>
    <div *ngIf="currentStream" class="stream-contents-container non-conforming-theme">
      <div class="stream-contents-header">
        <i class="pi pi-exclamation-triangle"></i>
        <span>Non-Conforming Files</span>
      </div>
      <div class="stream-contents-list">
        <div *ngFor="let file of nonConformingFiles; let i = index" class="stream-content-item">
          <div class="file-info">
            <i class="pi pi-file-o"></i>
            <span class="file-name">{{file.file_path}}</span>
            <span class="file-index">#{{i + 1}}</span>
          </div>
          <div *ngIf="file.validation_error_reason" class="validation-error">
            <i class="pi pi-exclamation-circle"></i>
            <span class="error-reason">{{file.validation_error_reason}}</span>
          </div>
        </div>
        <div *ngIf="!nonConformingFiles || nonConformingFiles.length === 0" class="no-contents-message">
          <i class="pi pi-check-circle"></i>
          <span>All files conform to Matter Spec.</span>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="popupId.includes('IMAGE_')">
    <img #imageView width="640" height="480" alt="No Image">
  </div>

  <div *ngFor="let inputItem of inputItems" class="input-items-div">
    <input *ngIf="inputItem.type === 'inputbox'" type="text" pInputText [(ngModel)]="inputItem.value"
      [placeholder]="inputItem.placeHolder" class="popup-inputbox" />

    <p-dropdown *ngIf="inputItem.type === 'dropdown'" [options]="inputItem.options" [(ngModel)]="inputItem.value"
      optionLabel="name" class="popup-dropdown" appendTo="body"></p-dropdown>

    <div *ngIf="inputItem.type === 'radioButton'" class="popup-radio-div p-field-checkbox">
      <div *ngFor="let radioItem of inputItem.options" class="popup-radio-row">
        <p-radioButton [name]="inputItem.groupName" [value]="radioItem.key" [(ngModel)]="inputItem.value"
          [inputId]="'radio_'+radioItem.key">
        </p-radioButton>
        <label [for]="'radio_'+radioItem.key">{{radioItem.value}}</label>
      </div>
    </div>

    <div *ngIf="inputItem.type === 'file_upload'" class="upload-popup">
      <div class="upload-file" fxLayout fxLayoutAlign="none center">
        <div class="file-upload">
          <input type="file" (change)="onUpload($event)" id="file" class="input-file">
          <label for="file">
            <i class="pi pi-upload"></i> Browse
          </label>
        </div>
        <p class="file-name" *ngIf="fileName"><i class="icon-document-text-1"></i>{{fileName}}</p>
      </div>
    </div>

  </div>

  <div class="buttons-div">
    <button pButton *ngFor="let button of buttons" type="button" [label]="button.label" [icon]="button.iconClass"
      [class]="button.class + ' popup-button'" [ngClass]="{'disabled-icon': checkInput(inputItems)}"
      (click)="button.callback(inputItems, messageId,file)"></button>
  </div>
</p-dialog>
